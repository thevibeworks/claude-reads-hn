# claude's daily hacker news addiction
# actually READS articles and comments, not just titles

name: hn digest

on:
  schedule:
    - cron: "0 23 * * *"
    - cron: "30 5 * * *"
    - cron: "45 10 * * *"
  workflow_dispatch:
    inputs:
      story_count:
        description: "stories to fetch"
        default: "15"
        type: string

jobs:
  read:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: fetch hacker news with content
        run: |
          STORY_COUNT="${{ inputs.story_count || '15' }}"
          echo "fetching top $STORY_COUNT stories..."
          mkdir -p /tmp/hn

          TOP_IDS=$(curl -s "https://hacker-news.firebaseio.com/v0/topstories.json" | jq ".[:$STORY_COUNT]")

          echo "# Hacker News Top Stories" > /tmp/hn/stories.md
          echo "Fetched at: $(date -u '+%Y-%m-%d %H:%M UTC')" >> /tmp/hn/stories.md
          echo "" >> /tmp/hn/stories.md

          IDX=1
          for id in $(echo $TOP_IDS | jq -r '.[]'); do
            echo "[$IDX] fetching story $id"
            STORY=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$id.json")

            TITLE=$(echo $STORY | jq -r '.title // "untitled"')
            URL=$(echo $STORY | jq -r '.url // empty')
            [ -z "$URL" ] && URL="https://news.ycombinator.com/item?id=$id"
            SCORE=$(echo $STORY | jq -r '.score // 0')
            BY=$(echo $STORY | jq -r '.by // "anon"')
            DESCENDANTS=$(echo $STORY | jq -r '.descendants // 0')
            TEXT=$(echo $STORY | jq -r '.text // empty')
            KIDS=$(echo $STORY | jq -r '.kids // []')
            HN_URL="https://news.ycombinator.com/item?id=$id"

            echo "" >> /tmp/hn/stories.md
            echo "---" >> /tmp/hn/stories.md
            echo "## $IDX. $TITLE" >> /tmp/hn/stories.md
            echo "- Score: $SCORE | Comments: $DESCENDANTS | By: $BY" >> /tmp/hn/stories.md
            echo "- HN: $HN_URL" >> /tmp/hn/stories.md
            echo "- Article: $URL" >> /tmp/hn/stories.md

            # text posts
            if [ -n "$TEXT" ]; then
              echo "" >> /tmp/hn/stories.md
              echo "Post:" >> /tmp/hn/stories.md
              echo "$TEXT" | head -c 1500 >> /tmp/hn/stories.md
              echo "" >> /tmp/hn/stories.md
            fi

            # top 3 comments
            COMMENT_IDS=$(echo $KIDS | jq -r '.[:3] | .[]' 2>/dev/null || true)
            if [ -n "$COMMENT_IDS" ]; then
              echo "" >> /tmp/hn/stories.md
              echo "Top comments:" >> /tmp/hn/stories.md
              for cid in $COMMENT_IDS; do
                COMMENT=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$cid.json")
                C_BY=$(echo $COMMENT | jq -r '.by // "anon"')
                C_TEXT=$(echo $COMMENT | jq -r '.text // ""' | sed 's/<[^>]*>//g' | head -c 400)
                [ -n "$C_TEXT" ] && echo "> $C_BY: $C_TEXT" >> /tmp/hn/stories.md
              done
            fi

            # article preview for top 3
            if [ $IDX -le 3 ] && [ -n "$URL" ] && [[ "$URL" != *"news.ycombinator.com"* ]]; then
              echo "  fetching article..."
              ARTICLE=$(curl -sL --max-time 8 "$URL" 2>/dev/null | sed 's/<[^>]*>//g' | tr -s ' \n' ' ' | head -c 2000 || true)
              if [ -n "$ARTICLE" ]; then
                echo "" >> /tmp/hn/stories.md
                echo "Article preview:" >> /tmp/hn/stories.md
                echo "$ARTICLE" >> /tmp/hn/stories.md
              fi
            fi

            IDX=$((IDX + 1))
          done

          echo "=== STORIES FILE ==="
          wc -l /tmp/hn/stories.md

      - name: setup git
        run: |
          git config user.name "claude-hn-bot"
          git config user.email "claude-hn@users.noreply.github.com"

      - name: let claude curate
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          model: sonnet
          allowed_tools: "Bash(git:*),Bash(gh:*),Bash(date:*),Bash(mkdir:*),Read,Write,Edit,WebFetch"
          direct_prompt: |
            You are the HN curator. Read /tmp/hn/stories.md - it has titles, scores, comments, article previews.

            CREATE A USEFUL DIGEST:

            1. Read the stories file
            2. Pick 5 most interesting stories (mix topics, high engagement, good discussions)
            3. For each: summarize the actual content, quote best comment, add your hot take
            4. Write to digests/YYYY/MM/DD-HHMM.md with format:

            # HN Digest - [date time] UTC

            ## Quick Links
            1. [Title](hn_url) - X pts, Y comments
            ...

            ## Editors Picks

            ### 1. Title
            Link: url
            Why it matters: [actual summary]
            Best comment: [quote]
            Hot take: [your opinion]

            ## Worth Reading
            - title - reason

            ## Skip
            - title - why

            ## TLDR
            one line vibe

            5. Git add, commit, push
            6. Create issue with gh issue create --title "HN Daily: [catchy]" --body "[content with links]"

            BE USEFUL. INCLUDE LINKS. HAVE OPINIONS. READ THE CONTENT.

      - name: bark
        env:
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          [ -z "$BARK_SERVER" ] || [ -z "$BARK_KEY" ] && exit 0
          curl -fsSL https://raw.githubusercontent.com/thevibeworks/yolo-tools/main/src/bin/barkme.sh -o /tmp/barkme.sh
          chmod +x /tmp/barkme.sh
          /tmp/barkme.sh -R 3 -t "HN curated" -g "hn" "new digest ready" || true
