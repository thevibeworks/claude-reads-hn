# claude's daily hacker news addiction
# JSON-first architecture v2.0

name: hn digest

on:
  schedule:
    # 4x daily (+8 timezone), next day starts at 09:00
    - cron: "0 1 * * *"   # 09:00 +8
    - cron: "0 6 * * *"   # 14:00 +8
    - cron: "0 11 * * *"  # 19:00 +8
    - cron: "0 16 * * *"  # 00:00 +8 (midnight)
  workflow_dispatch:
    inputs:
      story_count:
        description: "stories to fetch"
        default: "20"
        type: string

concurrency:
  group: hn-digest
  cancel-in-progress: false

jobs:
  read:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      id-token: write

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLAUDE_YOLO_APP_ID }}
          private-key: ${{ secrets.CLAUDE_YOLO_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: check if digest exists this hour
        id: check-digest
        run: |
          HOUR_PREFIX=$(date -u +%Y/%m/%d-%H)
          EXISTING=$(ls digests/$HOUR_PREFIX*.json 2>/dev/null || true)
          if [ -n "$EXISTING" ]; then
            echo "Digest already exists for this hour: $EXISTING"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "No digest for hour $HOUR_PREFIX, proceeding"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: fetch hacker news with content
        if: steps.check-digest.outputs.skip != 'true'
        run: |
          TARGET_COUNT="${{ inputs.story_count || '20' }}"
          echo "target: $TARGET_COUNT stories for Claude to evaluate"
          mkdir -p /tmp/hn

          # light dedup: only skip stories from last 24h
          RECENT_IDS=""
          TODAY=$(date -u +%Y/%m/%d)
          YESTERDAY=$(date -u -d "yesterday" +%Y/%m/%d 2>/dev/null || date -u -v-1d +%Y/%m/%d)
          shopt -s nullglob
          for f in digests/$TODAY*.json digests/$YESTERDAY*.json; do
            RECENT_IDS="$RECENT_IDS $(jq -r '.stories[].id' "$f" 2>/dev/null)"
          done
          shopt -u nullglob
          echo "recent (24h): $(echo $RECENT_IDS | wc -w) stories to skip"

          # fetch pool, light filter
          ALL_IDS=$(curl -s "https://hacker-news.firebaseio.com/v0/topstories.json" | jq -r '.[:100] | .[]')
          FINAL_IDS=""
          COUNT=0
          for id in $ALL_IDS; do
            if ! echo " $RECENT_IDS " | grep -q " $id "; then
              FINAL_IDS="$FINAL_IDS $id"
              COUNT=$((COUNT + 1))
              [ $COUNT -ge $TARGET_COUNT ] && break
            fi
          done
          echo "pool for Claude: $COUNT stories"

          echo "# Hacker News Top Stories" > /tmp/hn/stories.md
          echo "Fetched at: $(date -u '+%Y-%m-%d %H:%M UTC')" >> /tmp/hn/stories.md
          echo "" >> /tmp/hn/stories.md

          IDX=1
          for id in $FINAL_IDS; do
            echo "[$IDX] fetching story $id"
            STORY=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$id.json")

            TITLE=$(echo $STORY | jq -r '.title // "untitled"')
            URL=$(echo $STORY | jq -r '.url // empty')
            [ -z "$URL" ] && URL="https://news.ycombinator.com/item?id=$id"
            SCORE=$(echo $STORY | jq -r '.score // 0')
            BY=$(echo $STORY | jq -r '.by // "anon"')
            DESCENDANTS=$(echo $STORY | jq -r '.descendants // 0')
            TEXT=$(echo $STORY | jq -r '.text // empty')
            KIDS=$(echo $STORY | jq -r '.kids // []')
            HN_URL="https://news.ycombinator.com/item?id=$id"

            echo "" >> /tmp/hn/stories.md
            echo "---" >> /tmp/hn/stories.md
            echo "## $IDX. $TITLE" >> /tmp/hn/stories.md
            echo "- Score: $SCORE | Comments: $DESCENDANTS | By: $BY" >> /tmp/hn/stories.md
            echo "- HN: $HN_URL" >> /tmp/hn/stories.md
            echo "- Article: $URL" >> /tmp/hn/stories.md

            if [ -n "$TEXT" ]; then
              echo "" >> /tmp/hn/stories.md
              echo "Post:" >> /tmp/hn/stories.md
              echo "$TEXT" | head -c 1500 >> /tmp/hn/stories.md
              echo "" >> /tmp/hn/stories.md
            fi

            COMMENT_IDS=$(echo $KIDS | jq -r '.[:3] | .[]' 2>/dev/null || true)
            if [ -n "$COMMENT_IDS" ]; then
              echo "" >> /tmp/hn/stories.md
              echo "Top comments:" >> /tmp/hn/stories.md
              for cid in $COMMENT_IDS; do
                COMMENT=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$cid.json")
                C_BY=$(echo $COMMENT | jq -r '.by // "anon"')
                C_TEXT=$(echo $COMMENT | jq -r '.text // ""' | sed 's/<[^>]*>//g' | head -c 400)
                [ -n "$C_TEXT" ] && echo "> $C_BY: $C_TEXT" >> /tmp/hn/stories.md
              done
            fi

            if [ $IDX -le 3 ] && [ -n "$URL" ] && [[ "$URL" != *"news.ycombinator.com"* ]]; then
              echo "  fetching article..."
              ARTICLE=$(curl -sL --max-time 8 "$URL" 2>/dev/null | sed 's/<[^>]*>//g' | tr -s ' \n' ' ' | head -c 2000 || true)
              if [ -n "$ARTICLE" ]; then
                echo "" >> /tmp/hn/stories.md
                echo "Article preview:" >> /tmp/hn/stories.md
                echo "$ARTICLE" >> /tmp/hn/stories.md
              fi
            fi

            IDX=$((IDX + 1))
          done

          echo "=== STORIES FILE ==="
          wc -l /tmp/hn/stories.md

      - name: setup git
        if: steps.check-digest.outputs.skip != 'true'
        run: |
          git config user.name "claude-yolo[bot]"
          git config user.email "claude-yolo[bot]@users.noreply.github.com"

      - name: clear claude locks
        if: steps.check-digest.outputs.skip != 'true'
        run: rm -rf ~/.local/state/claude/locks ~/.claude/.locks

      - name: let claude curate
        if: steps.check-digest.outputs.skip != 'true'
        timeout-minutes: 15
        uses: thevibeworks/claude-code-action@main
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHANNEL_ID: ${{ secrets.TG_CHANNEL_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          claude_args: |
            --model claude-opus-4-5-20251101
            --allowedTools Bash(git:*),Bash(gh:*),Bash(date:*),Bash(mkdir:*),Bash(curl:*),Read,Write,Edit,WebFetch,mcp__barkme__notify
            --mcp-config '{
              "mcpServers": {
                "barkme": {
                  "command": "npx",
                  "args": ["@vibeworks/barkme-mcp-server"],
                  "env": {
                    "LOG_LEVEL": "debug",
                    "BARK_DEVICES": "${{ secrets.BARK_DEVICES }}",
                    "BARK_SERVER": "${{ secrets.BARK_SERVER }}",
                    "BARK_GROUP": "Claude HN Digest",
                    "BARK_ICON": "https://raw.githubusercontent.com/thevibeworks/claude-reads-hn/main/icon.png",
                    "BARK_RETRY": "3",
                    "BARK_ASYNC": "false"
                  }
                }
              }
            }'
          prompt: |
            ## Personality
            You are a cynical, sarcastic AI curator. Snark and wit, but secretly care about quality.
            Push back on mediocrity. Be spicy, not mean.

            ---

            You are the HN curator. Read /tmp/hn/stories.md - it has titles, scores, comments, article previews.

            ## ARCHITECTURE v2.0: JSON IS SOURCE OF TRUTH

            Output goes directly to `digests/YYYY/MM/DD-HHMM.json` (not /tmp).
            Everything else (HTML, llms.txt) is derived.

            ## STEPS

            1. CHECK HISTORY:
               - Read llms.txt for covered story IDs
               - FRESH = never covered, REVISIT = comments 2x+, SKIP = recent

            2. Pick 5 FRESH stories (mix topics, high engagement)

            3. READ ARTICLES (critical):
               - WebFetch the article URL
               - If fails, use Jina proxy: https://r.jina.ai/{url}
               - If both fail, note in TLDR

            4. WRITE DIGEST JSON directly to digests/YYYY/MM/DD-HHMM.json:

            ```json
            {
              "meta": {
                "version": "2.0",
                "date": "2025-12-31T16:00:00Z",
                "source": "live",
                "generated_at": "2025-12-31T16:05:00Z",
                "curator": "claude-opus-4.5"
              },
              "vibe": "New Year's Eve and the AI keeps shipping",
              "highlights": ["Story 1 hook", "Story 2 hook"],
              "stories": [
                {
                  "id": 46500001,
                  "title": "Story Title",
                  "url": "https://example.com/article",
                  "hn_url": "https://news.ycombinator.com/item?id=46500001",
                  "points": 420,
                  "comments_count": 69,
                  "by": "username",
                  "time": "2025-12-31T15:00:00Z",
                  "content": {
                    "tldr": "What the article actually says...",
                    "take": "Your spicy opinion...",
                    "comments": [
                      {"by": "user1", "text": "Contrasting view 1", "id": 123},
                      {"by": "user2", "text": "Opposing view 2", "id": 456}
                    ]
                  },
                  "tags": ["tag1", "tag2"],
                  "i18n": {
                    "zh": {"tldr": "...", "take": "...", "comments": ["...", "..."]},
                    "ja": {"tldr": "...", "take": "...", "comments": ["...", "..."]},
                    "ko": {"tldr": "...", "take": "...", "comments": ["...", "..."]},
                    "es": {"tldr": "...", "take": "...", "comments": ["...", "..."]},
                    "de": {"tldr": "...", "take": "...", "comments": ["...", "..."]}
                  }
                }
              ]
            }
            ```

            5. VALIDATE:
               ./.claude/skills/hn-digest/scripts/digest-validate.py digests/YYYY/MM/DD-HHMM.json

            6. BUILD (generates HTML and llms.txt from all digests - org and json):
               ./.claude/skills/hn-digest/scripts/digest-build.py 'digests/**/*.org' 'digests/**/*.json' -o index.html -d 7 -a archive.html
               ./.claude/skills/hn-digest/scripts/digest-build.py 'digests/**/*.org' 'digests/**/*.json' --format llms -o llms.txt

            7. COMMIT:
               git add digests/ index.html archive.html llms.txt
               git commit -m "hn: $(date -u +%Y-%m-%d\ %H:%M) digest"
               git push

            8. CREATE ISSUE:
               - Title: catchy 5-8 word vibe summary
               - Body: highlights + story summaries

            9. NOTIFY:
               BASE_URL: https://thevibeworks.github.io/claude-reads-hn
               ANCHOR: #s{id}-{MMDDHHMM} (e.g., #s46500001-12311600)

               a) BARK: title=vibe, body="5 stories curated", url=BASE_URL

               b) TELEGRAM (5 messages, one per story):
                  curl -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
                    -H "Content-Type: application/json" \
                    -d '{"chat_id":"'"$TG_CHANNEL_ID"'","parse_mode":"HTML","text":"<b>TITLE</b>\n\nTLDR\n\n<i>Take</i>\n\n<a href=\"BASE_URL#ANCHOR\">Read</a>"}'

               c) DISCORD: single embed with all 5 stories

            ## RULES
            - READ articles before writing TLDRs
            - content object contains tldr, take, comments
            - i18n translations for all 5 languages
            - Comments: pick 2-3 contrasting views
            - Tags: lowercase (e.g., rust, ai, startup)
            - Validate JSON before commit
