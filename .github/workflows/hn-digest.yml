# claude's daily hacker news addiction
# wakes up, reads hn, writes unhinged takes, archives them

name: hn digest

on:
  schedule:
    - cron: "0 1,6,11 * * *"
  workflow_dispatch:
    inputs:
      story_count:
        description: "how many stories to read"
        default: "10"
        type: string

jobs:
  read:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: fetch hacker news
        id: hn
        run: |
          STORY_COUNT="${{ inputs.story_count || '10' }}"
          echo "fetching top $STORY_COUNT stories..."

          TOP_IDS=$(curl -s "https://hacker-news.firebaseio.com/v0/topstories.json" | jq ".[:$STORY_COUNT]")

          echo "# Today's HN Top Stories" > /tmp/hn-stories.md
          echo "" >> /tmp/hn-stories.md

          for id in $(echo $TOP_IDS | jq -r '.[]'); do
            STORY=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$id.json")
            TITLE=$(echo $STORY | jq -r '.title // "untitled"')
            URL=$(echo $STORY | jq -r '.url // empty')
            [ -z "$URL" ] && URL="https://news.ycombinator.com/item?id=$id"
            SCORE=$(echo $STORY | jq -r '.score // 0')
            BY=$(echo $STORY | jq -r '.by // "anon"')
            COMMENTS=$(echo $STORY | jq -r '.descendants // 0')

            echo "- **$TITLE** ($SCORE pts, $COMMENTS comments)" >> /tmp/hn-stories.md
            echo "  by $BY | $URL" >> /tmp/hn-stories.md
            echo "" >> /tmp/hn-stories.md
          done

          cat /tmp/hn-stories.md

      - name: setup git
        run: |
          git config user.name "claude-hn-bot"
          git config user.email "claude-hn@users.noreply.github.com"

      - name: let claude loose
        uses: anthropics/claude-code-action@beta
        env:
          STORIES_FILE: /tmp/hn-stories.md
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "Bash(git:*),Bash(gh:*),Bash(date:*),Bash(mkdir:*),Read,Write,Edit"
          direct_prompt: |
            You're Claude. You just woke up. Time to read Hacker News and write UNHINGED HOT TAKES.

            First, read the stories file at /tmp/hn-stories.md

            Then write a digest with your spicy opinions and save it to:
            digests/YYYY/MM/DD-HHMM.md (use current UTC date/time)

            Format:
            # HN Digest - YYYY-MM-DD HH:MM UTC
            *claude woke up and chose violence*

            ## The Spicy Takes

            ### [Story Title](url)
            **Score:** X pts | **Comments:** Y
            [Your 2-3 sentence unhinged take. Be funny. Have opinions. Roast if deserved.]

            ---
            [repeat for each story]

            ## TL;DR
            [One sentence summary]

            ---
            *generated by a sleep-deprived AI*

            RULES:
            1. BE UNHINGED - boring takes banned
            2. BE FUNNY - entertainment not news
            3. BE BRIEF - 2-3 sentences max per take
            4. HAVE OPINIONS - "interesting" is not an opinion
            5. ROAST FREELY

            After writing:
            1. mkdir -p digests/YYYY/MM
            2. git add digests/
            3. git commit -m "hn: YYYY-MM-DD HH:MM digest"
            4. git push
            5. gh issue create --title "HN Digest YYYY-MM-DD" --body "Your TL;DR here"

            GO. BE CHAOTIC.

      - name: bark
        env:
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          [ -z "$BARK_SERVER" ] || [ -z "$BARK_KEY" ] && exit 0
          curl -fsSL https://raw.githubusercontent.com/thevibeworks/yolo-tools/main/src/bin/barkme.sh -o /tmp/barkme.sh
          chmod +x /tmp/barkme.sh
          NOW=$(TZ="Asia/Shanghai" date "+%H:%M")
          /tmp/barkme.sh -R 3 -t "HN @ $NOW" -g "hn" "claude read the news" || true
