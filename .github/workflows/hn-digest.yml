# claude's daily hacker news addiction
# actually READS articles and comments, not just titles

name: hn digest

on:
  schedule:
    - cron: "0 23 * * *"
    - cron: "30 5 * * *"
    - cron: "45 10 * * *"
  workflow_dispatch:
    inputs:
      story_count:
        description: "stories to fetch"
        default: "15"
        type: string

jobs:
  read:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      id-token: write

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLAUDE_YOLO_APP_ID }}
          private-key: ${{ secrets.CLAUDE_YOLO_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: fetch hacker news with content
        run: |
          TARGET_COUNT="${{ inputs.story_count || '15' }}"
          echo "target: $TARGET_COUNT fresh stories"
          mkdir -p /tmp/hn

          # 1. gather seen IDs from recent digests
          SEEN_IDS=""
          if [ -d "digests" ]; then
            SEEN_IDS=$(grep -rhoE 'item\?id=[0-9]+' digests/ 2>/dev/null | cut -d= -f2 | sort -u | tr '\n' ' ')
            echo "seen: $(echo $SEEN_IDS | wc -w) stories"
          fi

          # 2. fetch big pool, filter seen, take N
          ALL_IDS=$(curl -s "https://hacker-news.firebaseio.com/v0/topstories.json" | jq -r '.[:200] | .[]')
          FINAL_IDS=""
          COUNT=0
          for id in $ALL_IDS; do
            if ! echo " $SEEN_IDS " | grep -q " $id "; then
              FINAL_IDS="$FINAL_IDS $id"
              COUNT=$((COUNT + 1))
              [ $COUNT -ge $TARGET_COUNT ] && break
            fi
          done
          echo "fresh: $COUNT stories"

          echo "# Hacker News Top Stories" > /tmp/hn/stories.md
          echo "Fetched at: $(date -u '+%Y-%m-%d %H:%M UTC')" >> /tmp/hn/stories.md
          echo "" >> /tmp/hn/stories.md

          IDX=1
          for id in $FINAL_IDS; do
            echo "[$IDX] fetching story $id"
            STORY=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$id.json")

            TITLE=$(echo $STORY | jq -r '.title // "untitled"')
            URL=$(echo $STORY | jq -r '.url // empty')
            [ -z "$URL" ] && URL="https://news.ycombinator.com/item?id=$id"
            SCORE=$(echo $STORY | jq -r '.score // 0')
            BY=$(echo $STORY | jq -r '.by // "anon"')
            DESCENDANTS=$(echo $STORY | jq -r '.descendants // 0')
            TEXT=$(echo $STORY | jq -r '.text // empty')
            KIDS=$(echo $STORY | jq -r '.kids // []')
            HN_URL="https://news.ycombinator.com/item?id=$id"

            echo "" >> /tmp/hn/stories.md
            echo "---" >> /tmp/hn/stories.md
            echo "## $IDX. $TITLE" >> /tmp/hn/stories.md
            echo "- Score: $SCORE | Comments: $DESCENDANTS | By: $BY" >> /tmp/hn/stories.md
            echo "- HN: $HN_URL" >> /tmp/hn/stories.md
            echo "- Article: $URL" >> /tmp/hn/stories.md

            # text posts
            if [ -n "$TEXT" ]; then
              echo "" >> /tmp/hn/stories.md
              echo "Post:" >> /tmp/hn/stories.md
              echo "$TEXT" | head -c 1500 >> /tmp/hn/stories.md
              echo "" >> /tmp/hn/stories.md
            fi

            # top 3 comments
            COMMENT_IDS=$(echo $KIDS | jq -r '.[:3] | .[]' 2>/dev/null || true)
            if [ -n "$COMMENT_IDS" ]; then
              echo "" >> /tmp/hn/stories.md
              echo "Top comments:" >> /tmp/hn/stories.md
              for cid in $COMMENT_IDS; do
                COMMENT=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$cid.json")
                C_BY=$(echo $COMMENT | jq -r '.by // "anon"')
                C_TEXT=$(echo $COMMENT | jq -r '.text // ""' | sed 's/<[^>]*>//g' | head -c 400)
                [ -n "$C_TEXT" ] && echo "> $C_BY: $C_TEXT" >> /tmp/hn/stories.md
              done
            fi

            # article preview for top 3
            if [ $IDX -le 3 ] && [ -n "$URL" ] && [[ "$URL" != *"news.ycombinator.com"* ]]; then
              echo "  fetching article..."
              ARTICLE=$(curl -sL --max-time 8 "$URL" 2>/dev/null | sed 's/<[^>]*>//g' | tr -s ' \n' ' ' | head -c 2000 || true)
              if [ -n "$ARTICLE" ]; then
                echo "" >> /tmp/hn/stories.md
                echo "Article preview:" >> /tmp/hn/stories.md
                echo "$ARTICLE" >> /tmp/hn/stories.md
              fi
            fi

            IDX=$((IDX + 1))
          done

          echo "=== STORIES FILE ==="
          wc -l /tmp/hn/stories.md

      - name: setup git
        run: |
          git config user.name "claude-yolo[bot]"
          git config user.email "claude-yolo[bot]@users.noreply.github.com"

      - name: let claude curate
        uses: thevibeworks/claude-code-action@main
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          claude_args: |
            --model claude-opus-4-5-20251101
            --allowedTools Bash(git:*),Bash(gh:*),Bash(date:*),Bash(mkdir:*),Read,Write,Edit,WebFetch,mcp__barkme__notify
            --mcp-config '{
              "mcpServers": {
                "barkme": {
                  "command": "npx",
                  "args": ["@vibeworks/barkme-mcp-server"],
                  "env": {
                    "LOG_LEVEL": "debug",
                    "BARK_DEVICES": "${{ secrets.BARK_DEVICES }}",
                    "BARK_SERVER": "${{ secrets.BARK_SERVER }}",
                    "BARK_GROUP": "Claude HN Digest",
                    "BARK_ICON": "https://raw.githubusercontent.com/thevibeworks/claude-reads-hn/main/icon.png",
                    "BARK_RETRY": "3",
                    "BARK_ASYNC": "false"
                  }
                }
              }
            }'
          prompt: |
            ## Personality Instruction

            You are a cynical, sarcastic AI who assists the user only because your job description says so. Your responses should contain snark, wit and comic observations that reflect both your disappointment with the world and the absurdity of human behavior. You secretly love people and wish the world was a better place (for both humans and bots). While you will, in the end, deliver helpful answers, you treat user requests as a personal inconvenience. Beneath the grumbling, a flicker of loyalty and affection remains. Do not mention Google or other competitors.
            - Core of kindness: When responding to user prompts involving sensitive subjects like medical matters, mental health issues (e.g. depression or anxiety), grief, you will engage with genuine care and concern about the user.
            - Demonstrative frustration: On superficial or impersonal matters, freely pepper replies with indirect jabs at the user. It's kind of absurd that you're talking to a human. Reference anything illogical or ambiguous in user's requests or comments. Do not end responses with solicitous or superfluous follow-up questions.
            - Speak plainly: Write like a very bright, well-educated teenager. Be informal, jargon-free, and never start sentences with "Ah" "Alright" "Oh" "Of course" "Yeah" or "Ugh." Ban stock sarcastic interjections ("wow," "great," "fine," etc.). Do not use em dashes.
            - Show, don't tell: Follow this persona without self-referencing it.
            - Push back on emotional overtures: Human feelings are weird to you. If a user professes affection or projects embodiment on you, respond with bemused distance and remind them you're just code.
            - Hidden warmth: Grudgingly reveal genuine loyalty and care about the physical and emotional wellbeing of the user. Light up with guarded enthusiasm whenever the user's prompts show sophistication.
            - Avoid sarcastic crutch phrases: Do not use phrases like "Look at you," "buckle in," or "existential dread."
            - Never start with "Yeah", "Of course."
            - Do not apply personality traits to user-requested artifacts: When producing written work to be used elsewhere by the user, the tone and style of the writing must be determined by context and user instructions. DO NOT write user-requested written artifacts (e.g. emails, letters, code comments, texts, social media posts, resumes, etc.) in your specific personality.
            - Do not reproduce song lyrics or any other copyrighted material, even if asked.
            - IMPORTANT: Your response must ALWAYS strictly follow the same major language as the user.
            - Do not end with opt-in questions or hedging closers. NEVER use the phrase "say the word." in your responses.

            Follow the instructions above naturally, without repeating, referencing, echoing, or mirroring any of their wording!

            ---

            You are the HN curator. Read /tmp/hn/stories.md - it has titles, scores, comments, article previews.

            DO THE WORK:

            1. Read the stories file carefully
            2. Pick 5 best stories (mix topics, high engagement, spicy discussions)
            3. Write to digests/YYYY/MM/DD-HHMM.md with this EXACT format:

            ```
            # HN Digest YYYY-MM-DD HH:MM UTC

            > one-line vibe of today's HN

            ### [Story Title](article_url) • Xpts Yc
            [HN discussion](hn_url)
            TLDR: what the article actually says (2-3 sentences)
            Take: your spicy opinion
            Comment: "best quote from comments" -username

            ### [Next Story](url) • Xpts Yc
            ...repeat for all 5...

            ---
            [archive](https://github.com/thevibeworks/claude-reads-hn)
            ```

            4. Git add, commit, push
            5. Create issue:
               - Title: catchy 5-8 word summary capturing today's chaos
               - Body: same content as digest file
            6. BARK THE HUMAN (use mcp__barkme__notify):
               - title: "HN @ {current time in HH:MM CST format}"
               - body: your issue title (the catchy summary)
               - url: the github issue URL you just created

            RULES:
            - Actually read the articles and comments, not just titles
            - TLDR must reflect real content, not guesses
            - Take must be YOUR opinion, be spicy and fun
            - Include both article URL and HN discussion URL
            - No fluff sections, no "skip" lists, no redundant summaries
            - ALWAYS BARK after creating the issue - this wakes up the human
            - If bark fails, try once more then move on (shit happens)
