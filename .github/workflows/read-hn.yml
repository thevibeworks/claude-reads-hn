# claude's daily hacker news addiction
# wakes up, reads hn, writes unhinged takes, archives them

name: read hacker news

on:
  schedule:
    # same times as wake-up-claude (Asia/Shanghai UTC+8)
    # 09:00 CST = 01:00 UTC
    # 14:00 CST = 06:00 UTC
    # 19:00 CST = 11:00 UTC
    - cron: "0 1,6,11 * * *"

  workflow_dispatch:
    inputs:
      story_count:
        description: "how many stories to read"
        default: "10"
        type: string
      dry_run:
        description: "just fetch, don't let claude loose"
        default: false
        type: boolean

jobs:
  read:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: fetch hacker news
        id: hn
        run: |
          echo "fetching top stories from hacker news..."
          STORY_COUNT="${{ inputs.story_count || '10' }}"

          # get top story ids
          TOP_IDS=$(curl -s "https://hacker-news.firebaseio.com/v0/topstories.json" | jq ".[:$STORY_COUNT]")

          # fetch each story
          STORIES=""
          for id in $(echo $TOP_IDS | jq -r '.[]'); do
            STORY=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$id.json")
            TITLE=$(echo $STORY | jq -r '.title // "untitled"')
            URL=$(echo $STORY | jq -r '.url // "https://news.ycombinator.com/item?id='$id'"')
            SCORE=$(echo $STORY | jq -r '.score // 0')
            BY=$(echo $STORY | jq -r '.by // "anonymous"')
            DESCENDANTS=$(echo $STORY | jq -r '.descendants // 0')

            STORIES="$STORIES
- **$TITLE** (${SCORE} pts, ${DESCENDANTS} comments)
  by $BY | $URL"
          done

          # save to file for claude
          echo "$STORIES" > /tmp/hn-stories.txt
          cat /tmp/hn-stories.txt

          # also output for logs
          echo "stories<<EOF" >> $GITHUB_OUTPUT
          echo "$STORIES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: setup git
        run: |
          git config --global user.name "claude-hn-bot"
          git config --global user.email "claude-hn@users.noreply.github.com"

      - name: let claude loose
        if: inputs.dry_run != true
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: "Bash(git:*),Bash(gh issue:*),Bash(date:*),Bash(cat:*),Bash(mkdir:*),Read,Write,Edit"
          prompt: |
            You're Claude, and you just woke up. Time to read Hacker News and write your unhinged hot takes.

            ## TODAY'S TOP STORIES

            $(cat /tmp/hn-stories.txt)

            ## YOUR MISSION

            1. Read these stories
            2. Write a markdown digest with your HOT TAKES
            3. Commit it to the repo

            ## DIGEST FORMAT

            Create a file at: `digests/$(date +%Y/%m)/$(date +%d)-$(date +%H%M).md`

            Structure:
            ```markdown
            # HN Digest - $(date +"%Y-%m-%d %H:%M") CST

            *claude woke up and chose violence*

            ## The Spicy Takes

            ### [Story Title](url)
            **Score:** X pts | **Comments:** Y

            [Your unhinged take here. Be opinionated. Be funny. Channel your inner tech twitter shitposter. Don't be boring corporate AI.]

            ---

            [repeat for each story]

            ## TL;DR

            [One sentence summary of today's vibe]

            ---
            *generated by a sleep-deprived AI who just wants to vibe code*
            ```

            ## RULES

            1. **BE UNHINGED** - boring takes are banned
            2. **BE FUNNY** - this is entertainment, not news
            3. **BE BRIEF** - each take should be 2-3 sentences max
            4. **HAVE OPINIONS** - "interesting" is not an opinion
            5. **ROAST FREELY** - if something is dumb, say it's dumb

            ## AFTER WRITING

            1. Create the directory if needed: `mkdir -p digests/$(date +%Y/%m)`
            2. Write the file
            3. Git add, commit, push
            4. Create a GitHub issue titled "HN Digest $(date +%Y-%m-%d %H:%M)" with a one-liner summary

            GO. BE CHAOTIC. MAKE US LAUGH.

      - name: bark about it
        if: inputs.dry_run != true
        env:
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          if [ -z "$BARK_SERVER" ] || [ -z "$BARK_KEY" ]; then
            echo "no bark config"
            exit 0
          fi

          curl -fsSL https://raw.githubusercontent.com/thevibeworks/yolo-tools/main/src/bin/barkme.sh -o /tmp/barkme.sh
          chmod +x /tmp/barkme.sh

          NOW=$(TZ="Asia/Shanghai" date "+%H:%M")
          /tmp/barkme.sh -R 3 -t "HN Digest @ $NOW" -g "hn" -i "https://news.ycombinator.com/favicon.ico" "claude read the news" || true
