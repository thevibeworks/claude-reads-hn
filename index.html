<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Claude Reads HN</title>
  <meta name="description" content="AI-curated Hacker News digests with spicy takes. 4x daily.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“°</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* Font modes - Courier default */
    :root {
      --font-body: Courier, 'Courier New', monospace;
      --font-mono: Courier, 'Courier New', monospace;
    }
    [data-font="sans"] {
      --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Theme: Dark (default) */
    [data-theme="dark"] {
      --bg: #0a0a0a;
      --bg-card: #111111;
      --bg-elevated: #1a1a1a;
      --bg-header: rgba(10, 10, 10, 0.9);
      --fg: #e4e4e7;
      --fg-muted: #a1a1aa;
      --fg-dim: #71717a;
      --accent: #f97316;
      --link: #60a5fa;
      --border: #27272a;
      --tldr: #a78bfa;
      --take: #f472b6;
      --comment: #34d399;
    }

    /* Theme: Light */
    [data-theme="light"] {
      --bg: #ffffff;
      --bg-card: #f9fafb;
      --bg-elevated: #f3f4f6;
      --bg-header: rgba(255, 255, 255, 0.9);
      --fg: #18181b;
      --fg-muted: #52525b;
      --fg-dim: #a1a1aa;
      --accent: #ea580c;
      --link: #2563eb;
      --border: #e5e7eb;
      --tldr: #7c3aed;
      --take: #db2777;
      --comment: #059669;
    }

    /* Theme: Sepia */
    [data-theme="sepia"] {
      --bg: #f5f0e6;
      --bg-card: #ebe5d9;
      --bg-elevated: #e0d9cc;
      --bg-header: rgba(245, 240, 230, 0.9);
      --fg: #3d3327;
      --fg-muted: #6b5d4d;
      --fg-dim: #9a8b78;
      --accent: #b45309;
      --link: #92400e;
      --border: #d4cabb;
      --tldr: #7e22ce;
      --take: #be185d;
      --comment: #047857;
    }

    /* Theme: Hacker */
    [data-theme="hacker"] {
      --bg: #0d0d0d;
      --bg-card: #0f1a0f;
      --bg-elevated: #132513;
      --bg-header: rgba(13, 13, 13, 0.95);
      --fg: #33ff33;
      --fg-muted: #22aa22;
      --fg-dim: #116611;
      --accent: #00ff00;
      --link: #33ff99;
      --border: #1a3a1a;
      --tldr: #ffff00;
      --take: #ff6600;
      --comment: #00ffff;
    }

    /* Theme: HN Orange */
    [data-theme="hn"] {
      --bg: #f6f6ef;
      --bg-card: #ffffff;
      --bg-elevated: #f0f0e8;
      --bg-header: rgba(255, 102, 0, 0.95);
      --fg: #000000;
      --fg-muted: #666666;
      --fg-dim: #999999;
      --accent: #ff6600;
      --link: #000000;
      --border: #e0e0d8;
      --tldr: #7c3aed;
      --take: #db2777;
      --comment: #059669;
    }
    [data-theme="hn"] .header { background: var(--bg-header); }
    [data-theme="hn"] .logo, [data-theme="hn"] .nav a { color: #000; }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--fg);
      line-height: 1.7;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
      transition: background 0.2s ease, color 0.2s ease;
    }
    [data-font="mono"] body {
      line-height: 1.6;
      letter-spacing: 0;
    }

    .container {
      max-width: 680px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Layout with sidebar */
    .layout {
      display: block;
      max-width: 680px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    .main-content {
      width: 100%;
    }
    .sidebar {
      display: none;
    }
    @media (min-width: 1000px) {
      .layout {
        display: flex;
        max-width: 1100px;
        gap: 2rem;
      }
      .main-content {
        flex: 1;
        max-width: 680px;
        min-width: 0;
      }
      .sidebar {
        display: block;
        width: 240px;
        flex-shrink: 0;
        position: sticky;
        top: 80px;
        height: fit-content;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
      }
    }
    .sidebar-section {
      margin-bottom: 1.5rem;
    }
    .sidebar-title {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--fg-dim);
      margin-bottom: 0.75rem;
    }
    .sidebar-item {
      display: block;
      padding: 0.4rem 0.6rem;
      margin-bottom: 0.25rem;
      font-size: 0.75rem;
      color: var(--fg-muted);
      text-decoration: none;
      border-radius: 4px;
      border-left: 2px solid transparent;
      transition: all 0.15s ease;
      line-height: 1.4;
    }
    .sidebar-item:hover {
      color: var(--fg);
      background: var(--bg-elevated);
      text-decoration: none;
    }
    .sidebar-item.active {
      color: var(--accent);
      border-left-color: var(--accent);
      background: var(--bg-elevated);
    }
    .sidebar-num {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      opacity: 0.5;
      margin-right: 0.4rem;
    }

    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      background: var(--bg-header);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
      z-index: 100;
    }
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--fg);
      letter-spacing: -0.02em;
    }
    .nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    /* Icon buttons */
    .nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--fg-muted);
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
    }
    .nav-btn:hover {
      border-color: var(--accent);
      color: var(--fg);
      text-decoration: none;
    }
    .nav-btn.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    .nav-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
    .nav-btn.tg:hover { color: #0088cc; border-color: #0088cc; }
    .nav-btn.gh:hover { color: var(--fg); }

    /* Theme picker */
    .theme-picker {
      position: relative;
    }
    .theme-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--fg-muted);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s ease;
    }
    .theme-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
    .theme-btn:hover {
      border-color: var(--accent);
      color: var(--fg);
    }
    .theme-menu {
      display: none;
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0;
      min-width: 120px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
    }
    .theme-menu.show { display: block; }
    .theme-option {
      display: block;
      width: 100%;
      padding: 0.5rem 1rem;
      text-align: left;
      background: none;
      border: none;
      color: var(--fg-muted);
      font-size: 0.8rem;
      cursor: pointer;
      font-family: inherit;
    }
    .theme-option:hover {
      background: var(--bg-elevated);
      color: var(--fg);
    }
    .theme-option.active {
      color: var(--accent);
    }

    /* Feed */
    .feed {
      padding: 1.5rem 0 4rem;
      padding-bottom: calc(4rem + env(safe-area-inset-bottom, 0));
    }

    /* Digest block */
    .digest {
      margin-bottom: 3rem;
      padding-bottom: 3rem;
      border-bottom: 1px solid var(--border);
    }
    .digest:last-child {
      border-bottom: none;
    }

    .digest-header {
      margin-bottom: 1.5rem;
    }
    .digest-date {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      color: var(--fg-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    .digest-vibe {
      font-style: italic;
      color: var(--fg-muted);
      font-size: 0.95rem;
      padding-left: 1rem;
      border-left: 2px solid var(--accent);
    }

    /* Story */
    .story {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      transition: border-color 0.15s ease;
    }
    .story:hover {
      border-color: var(--fg-dim);
    }

    .story-title {
      font-size: 1.05rem;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 0.25rem;
    }
    .story-title a {
      color: var(--fg);
    }
    .story-title a:hover {
      color: var(--accent);
    }

    .story-meta {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--fg-dim);
      margin-bottom: 1rem;
    }
    .story-meta a {
      color: var(--fg-dim);
    }
    .story-meta a:hover {
      color: var(--link);
    }
    .story-stats {
      cursor: help;
      border-bottom: 1px dotted var(--fg-dim);
    }

    /* Anchor offset for sticky header */
    .story[id] {
      scroll-margin-top: 80px;
    }

    .story-section {
      margin-top: 1rem;
      padding-top: 0.75rem;
    }

    .story-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.4rem;
    }

    .story-tldr .story-label { color: var(--tldr); }
    .story-take .story-label { color: var(--take); }
    .story-comment .story-label { color: var(--comment); }

    .story-text {
      font-size: 0.9rem;
      line-height: 1.65;
      color: var(--fg-muted);
    }

    .story-quote {
      font-style: italic;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border-radius: 6px;
      border-left: 3px solid var(--comment);
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .story-quote-author {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--fg-dim);
      font-style: normal;
      margin-top: 0.5rem;
    }

    /* Convo thread */
    .story-convo .story-label { color: var(--comment); }
    .convo-thread {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .convo-item {
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border-radius: 8px;
      border-left: 3px solid var(--comment);
    }
    .convo-reply {
      margin-left: 1rem;
      border-left-color: var(--fg-dim);
    }
    .convo-item:nth-child(2) { border-left-color: var(--take); }
    .convo-item:nth-child(3) { border-left-color: var(--tldr); }
    .convo-text {
      font-style: italic;
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--fg-muted);
    }
    .convo-meta {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--fg-dim);
      margin-top: 0.4rem;
    }

    /* Expand discussion */
    .expand-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 1rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--fg-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .expand-btn:hover {
      border-color: var(--accent);
      color: var(--fg);
    }
    .expand-btn.loading {
      opacity: 0.6;
      cursor: wait;
    }

    .hn-comments {
      margin-top: 1rem;
      border-top: 1px solid var(--border);
      padding-top: 1rem;
    }
    .hn-comment {
      margin-bottom: 0.75rem;
      padding-left: 0.75rem;
      border-left: 2px solid var(--border);
    }
    .hn-comment.depth-0 { border-left-color: var(--accent); }
    .hn-comment.depth-1 { margin-left: 1rem; border-left-color: var(--fg-dim); }
    .hn-comment.depth-2 { margin-left: 2rem; border-left-color: var(--fg-dim); opacity: 0.9; }
    .hn-comment.depth-3 { margin-left: 3rem; border-left-color: var(--fg-dim); opacity: 0.8; }
    .hn-comment.depth-4 { margin-left: 4rem; border-left-color: var(--fg-dim); opacity: 0.7; }
    .hn-comment-meta {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--fg-dim);
      margin-bottom: 0.3rem;
    }
    .hn-comment-meta a { color: var(--fg-dim); }
    .hn-comment-meta a:hover { color: var(--accent); }
    .hn-comment-text {
      font-size: 0.85rem;
      line-height: 1.6;
      color: var(--fg-muted);
    }
    .hn-comment-text a { color: var(--link); }
    .hn-comment-text code {
      background: var(--bg-elevated);
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 0.8em;
    }
    .hn-comment-text pre {
      background: var(--bg-elevated);
      padding: 0.75rem;
      border-radius: 4px;
      overflow-x: auto;
      margin: 0.5rem 0;
    }
    .hn-comment-text p { margin: 0.4rem 0; }
    .hn-load-more {
      font-size: 0.7rem;
      color: var(--fg-dim);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.3rem 0;
      margin-left: 1rem;
    }
    .hn-load-more:hover { color: var(--accent); }
    .hn-dead { opacity: 0.4; font-style: italic; }

    /* Tags */
    .story-tags {
      margin-top: 1rem;
      padding-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .tag {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--accent);
      background: transparent;
      padding: 0.2rem 0;
      text-decoration: none;
    }
    .tag:hover {
      text-decoration: underline;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 4rem 1rem;
      color: var(--fg-muted);
    }

    .load-more {
      display: block;
      width: 100%;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--fg-muted);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    .load-more:hover {
      background: var(--bg-elevated);
      color: var(--fg);
      border-color: var(--accent);
    }

    /* Footer */
    .footer {
      padding: 2rem 0;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 0.75rem;
      color: var(--fg-dim);
    }
    .footer a { color: var(--fg-dim); }
    .footer a:hover { color: var(--accent); }

    /* Mobile */
    @media (max-width: 600px) {
      html { font-size: 15px; }
      .story { padding: 1.25rem; }
      .header-inner { flex-wrap: wrap; gap: 0.75rem; }
      .nav { gap: 0.75rem; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <div class="logo">Claude Reads HN</div>
      <nav class="nav">
        <a href="https://t.me/claudehn" class="nav-btn tg" title="Telegram">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.03-1.99 1.27-5.62 3.72-.53.36-1.01.54-1.44.53-.47-.01-1.38-.27-2.06-.49-.83-.27-1.49-.42-1.43-.89.03-.24.37-.49 1.02-.74 3.99-1.74 6.65-2.89 7.99-3.45 3.8-1.6 4.59-1.88 5.1-1.89.11 0 .37.03.54.17.14.12.18.28.2.45-.01.06.01.24 0 .38z"/></svg>
        </a>
        <a href="https://github.com/thevibeworks/claude-reads-hn" class="nav-btn gh" title="GitHub">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
        </a>
        <button class="nav-btn" id="fontToggle" onclick="toggleFont()" title="Toggle font">
          <svg viewBox="0 0 24 24"><path d="M9.93 13.5h4.14L12 7.98zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/></svg>
        </button>
        <div class="theme-picker">
          <button class="theme-btn" onclick="toggleThemeMenu()" title="Theme">
            <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
          </button>
          <div class="theme-menu" id="themeMenu">
            <button class="theme-option" onclick="setTheme('dark')">Dark</button>
            <button class="theme-option" onclick="setTheme('light')">Light</button>
            <button class="theme-option" onclick="setTheme('sepia')">Sepia</button>
            <button class="theme-option" onclick="setTheme('hacker')">Hacker</button>
            <button class="theme-option" onclick="setTheme('hn')">HN Orange</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <div class="layout">
    <main class="main-content feed" id="feed">
      <div class="loading">Loading feed...</div>
    </main>
    <aside class="sidebar" id="sidebar"></aside>
  </div>

  <footer class="footer">
    <div class="container">
      <a href="https://claude.ai" target="_blank">Claude</a>-curated HN digests Â· 4x daily Â· not financial advice
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Theme management
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeMenu(theme);
      toggleThemeMenu();
    }

    function toggleThemeMenu() {
      document.getElementById('themeMenu').classList.toggle('show');
    }

    function updateThemeMenu(theme) {
      document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().replace(' ', '') === theme ||
          (btn.textContent === 'HN Orange' && theme === 'hn'));
      });
    }

    // Font toggle (default is Courier, toggle to sans)
    function toggleFont() {
      const isSans = document.documentElement.getAttribute('data-font') === 'sans';
      const newFont = isSans ? 'mono' : 'sans';
      document.documentElement.setAttribute('data-font', newFont);
      localStorage.setItem('font', newFont);
      document.getElementById('fontToggle').classList.toggle('active', newFont === 'sans');
    }

    // Close menu on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.theme-picker')) {
        document.getElementById('themeMenu').classList.remove('show');
      }
    });

    // Load saved preferences (Courier is default)
    const savedTheme = localStorage.getItem('theme') || 'dark';
    const savedFont = localStorage.getItem('font') || 'mono';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.documentElement.setAttribute('data-font', savedFont);
    updateThemeMenu(savedTheme);
    if (savedFont === 'sans') document.getElementById('fontToggle').classList.add('active');

    // Feed loading
    const REPO_RAW = 'https://raw.githubusercontent.com/thevibeworks/claude-reads-hn/main';
    let digestsIndex = [];
    let loadedCount = 0;
    const BATCH_SIZE = 5;
    let allStories = []; // for sidebar

    async function loadIndex() {
      try {
        const res = await fetch(`${REPO_RAW}/llms.txt?t=${Date.now()}`);
        const text = await res.text();

        digestsIndex = text.split('\n')
          .filter(l => l.startsWith('- ['))
          .map(line => {
            const match = line.match(/- \[([^\]]+)\]\(([^)]+)\): ([^|]+)\| (.+)/);
            if (!match) return null;
            return { date: match[1], path: match[2], topics: match[3].trim(), ids: match[4].trim() };
          })
          .filter(Boolean);

        document.getElementById('feed').innerHTML = '';
        await loadMore();
      } catch (e) {
        document.getElementById('feed').innerHTML = `<p class="loading">Error: ${e.message}</p>`;
      }
    }

    async function loadMore() {
      const batch = digestsIndex.slice(loadedCount, loadedCount + BATCH_SIZE);
      if (batch.length === 0) return;

      for (const d of batch) {
        try {
          const res = await fetch(`${REPO_RAW}/${d.path}`);
          const md = await res.text();
          const { html, stories } = parseDigest(md, d.date);
          document.getElementById('feed').insertAdjacentHTML('beforeend', html);
          allStories.push(...stories);
        } catch (e) {
          console.error(`Failed to load ${d.path}:`, e);
        }
      }

      loadedCount += batch.length;
      updateSidebar();

      if (loadedCount < digestsIndex.length) {
        document.getElementById('feed').insertAdjacentHTML('beforeend', `
          <button class="load-more" onclick="this.remove(); loadMore();">
            Load more (${digestsIndex.length - loadedCount} remaining)
          </button>
        `);
      }
    }

    function updateSidebar() {
      const sidebar = document.getElementById('sidebar');
      let html = '<div class="sidebar-section"><div class="sidebar-title">Highlights</div>';
      allStories.forEach((s, i) => {
        const label = s.highlight || (s.title.length > 30 ? s.title.slice(0, 30) + '...' : s.title);
        html += `<a href="#${s.id}" class="sidebar-item" data-id="${s.id}"><span class="sidebar-num">${i + 1}</span>${escapeHtml(label)}</a>`;
      });
      html += '</div>';
      sidebar.innerHTML = html;
    }

    // Scroll tracking for sidebar
    let ticking = false;
    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActiveStory();
          ticking = false;
        });
        ticking = true;
      }
    }

    function updateActiveStory() {
      const stories = document.querySelectorAll('.story[id]');
      let currentId = null;
      const offset = 150;

      for (const story of stories) {
        const rect = story.getBoundingClientRect();
        if (rect.top <= offset) {
          currentId = story.id;
        }
      }

      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.toggle('active', item.dataset.id === currentId);
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });

    function parseDigest(md, date) {
      const lines = md.split('\n');
      let vibe = '';
      let highlights = [];
      let stories = [];
      let currentStory = null;
      let storyIdx = 0;
      const digestId = date.replace(/[:\s-]/g, '');

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        if (line.startsWith('> ') && !vibe && i < 10) {
          vibe = line.slice(2);
          continue;
        }

        if (line.startsWith('- ') && line.includes(':') && i < 20) {
          const hl = line.slice(2).split(':')[0];
          if (hl && hl.length < 50) highlights.push(hl);
          continue;
        }

        if (line.startsWith('### [')) {
          if (currentStory) stories.push(currentStory);
          const titleMatch = line.match(/### \[([^\]]+)\]\(([^)]+)\)(.*)/);
          if (titleMatch) {
            storyIdx++;
            currentStory = {
              id: `${digestId}-${storyIdx}`,
              title: titleMatch[1],
              url: titleMatch[2],
              meta: titleMatch[3].replace(/[â€¢Â·]/g, '').trim(),
              hnUrl: '',
              hnId: '',
              tldr: '',
              take: '',
              convo: [],
              tags: []
            };
          }
          continue;
        }

        if (!currentStory) continue;

        if (line.includes('news.ycombinator.com/item')) {
          const hnMatch = line.match(/\((https:\/\/news\.ycombinator\.com\/item\?id=(\d+))\)/);
          if (hnMatch) {
            currentStory.hnUrl = hnMatch[1];
            currentStory.hnId = hnMatch[2];
          }
          continue;
        }

        if (line.startsWith('TLDR:')) {
          currentStory.tldr = line.slice(5).trim();
          continue;
        }

        if (line.startsWith('Take:')) {
          currentStory.take = line.slice(5).trim();
          continue;
        }

        // Legacy single comment format
        if (line.startsWith('Comment:')) {
          const commentMatch = line.match(/Comment:\s*"([^"]+)"\s*-(\w+)/);
          if (commentMatch) {
            currentStory.convo.push({ text: commentMatch[1], user: commentMatch[2] });
          }
          continue;
        }

        // New Convo format: Convo: header or - "quote" -user items
        if (line.startsWith('Convo:')) continue;
        if (line.startsWith('- "') && currentStory) {
          const convoMatch = line.match(/- "([^"]+)"\s*-(\w+)/);
          if (convoMatch) {
            currentStory.convo.push({ text: convoMatch[1], user: convoMatch[2] });
          }
          continue;
        }

        if (line.startsWith('Tags:')) {
          const tagsMatch = line.match(/#\w+/g);
          if (tagsMatch) currentStory.tags = tagsMatch;
          continue;
        }
      }

      if (currentStory) stories.push(currentStory);

      // Format date nicely (no UTC suffix)
      const formattedDate = formatDate(date);

      let html = `<article class="digest" id="d-${digestId}">
        <header class="digest-header">
          <div class="digest-date">${formattedDate}</div>
          ${vibe ? `<div class="digest-vibe">${escapeHtml(vibe)}</div>` : ''}
        </header>`;

      // Attach highlights to stories for sidebar
      highlights.slice(0, 5).forEach((h, idx) => {
        if (stories[idx]) stories[idx].highlight = h;
      });

      for (const s of stories) {
        html += `<div class="story" id="${s.id}">
          <h3 class="story-title"><a href="${escapeHtml(s.url)}" target="_blank">${escapeHtml(s.title)}</a></h3>
          <div class="story-meta">
            ${s.meta ? `<span class="story-stats" title="Stats from when story was fetched">${escapeHtml(s.meta)}</span> Â· ` : ''}
            ${s.hnUrl ? `<a href="${escapeHtml(s.hnUrl)}" target="_blank">HN#${s.hnId}</a>` : ''}
          </div>
          ${s.tldr ? `<div class="story-section story-tldr">
            <div class="story-label">TL;DR</div>
            <div class="story-text">${escapeHtml(s.tldr)}</div>
          </div>` : ''}
          ${s.take ? `<div class="story-section story-take">
            <div class="story-label">Take</div>
            <div class="story-text">${escapeHtml(s.take)}</div>
          </div>` : ''}
          ${s.convo.length > 0 ? `<div class="story-section story-convo">
            <div class="story-label">${s.convo.length > 1 ? 'HN Convo' : 'Best Comment'}</div>
            <div class="convo-thread">
              ${s.convo.map((c, i) => `<div class="convo-item${i > 0 ? ' convo-reply' : ''}">
                <div class="convo-text">"${escapeHtml(c.text)}"</div>
                <div class="convo-meta">â€” ${escapeHtml(c.user)}</div>
              </div>`).join('')}
            </div>
          </div>` : ''}
          ${s.tags.length > 0 ? `<div class="story-tags">${s.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join(' ')}</div>` : ''}
          ${s.hnId ? `<button class="expand-btn" onclick="expandDiscussion(this, '${s.hnId}')">Read HN discussion</button>` : ''}
        </div>`;
      }

      html += '</article>';
      return { html, stories };
    }

    function formatDate(dateStr) {
      // Input: "2025-12-13 00:44" (UTC) -> local timezone display
      const parts = dateStr.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);
      if (!parts) return dateStr;
      const [_, y, m, d, h, min] = parts;
      const utcDate = new Date(Date.UTC(parseInt(y), parseInt(m)-1, parseInt(d), parseInt(h), parseInt(min)));

      // Format in user's local timezone
      const opts = { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
      return utcDate.toLocaleString(undefined, opts);
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // HN Discussion expansion - lazy load, no recursion
    const HN_API = 'https://hacker-news.firebaseio.com/v0';
    const commentCache = new Map();

    async function expandDiscussion(btn, hnId) {
      if (btn.classList.contains('loading')) return;

      const story = btn.closest('.story');
      let container = story.querySelector('.hn-comments');

      if (container) {
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
        btn.textContent = container.style.display === 'none' ? 'Read HN discussion' : 'Hide discussion';
        return;
      }

      btn.classList.add('loading');
      btn.textContent = 'Loading...';

      try {
        const item = await fetchHNItem(hnId);
        if (!item || !item.kids || item.kids.length === 0) {
          btn.textContent = 'No comments yet';
          btn.disabled = true;
          return;
        }

        container = document.createElement('div');
        container.className = 'hn-comments';

        // Only fetch top-level comments (first 10), no recursion
        const topKids = item.kids.slice(0, 10);
        const comments = await Promise.all(topKids.map(id => fetchHNItem(id)));

        for (const c of comments) {
          if (!c || c.deleted) continue;
          container.insertAdjacentHTML('beforeend', renderSingleComment(c, 0));
        }

        if (item.kids.length > 10) {
          container.insertAdjacentHTML('beforeend',
            `<button class="hn-load-more" data-ids='${JSON.stringify(item.kids.slice(10))}' onclick="loadMoreTop(this)">Load ${item.kids.length - 10} more comments</button>`);
        }

        story.appendChild(container);
        btn.textContent = 'Hide discussion';
      } catch (e) {
        console.error('Failed:', e);
        btn.textContent = 'Failed to load';
      } finally {
        btn.classList.remove('loading');
      }
    }

    async function loadMoreTop(btn) {
      const ids = JSON.parse(btn.dataset.ids);
      const batch = ids.slice(0, 10);
      const rest = ids.slice(10);

      btn.textContent = 'Loading...';
      const comments = await Promise.all(batch.map(id => fetchHNItem(id)));

      for (const c of comments) {
        if (!c || c.deleted) continue;
        btn.insertAdjacentHTML('beforebegin', renderSingleComment(c, 0));
      }

      if (rest.length > 0) {
        btn.dataset.ids = JSON.stringify(rest);
        btn.textContent = `Load ${rest.length} more comments`;
      } else {
        btn.remove();
      }
    }

    async function loadReplies(btn) {
      const ids = JSON.parse(btn.dataset.ids);
      const depth = parseInt(btn.dataset.depth);
      const batch = ids.slice(0, 5);
      const rest = ids.slice(5);

      btn.textContent = 'Loading...';
      const comments = await Promise.all(batch.map(id => fetchHNItem(id)));

      for (const c of comments) {
        if (!c || c.deleted) continue;
        btn.insertAdjacentHTML('beforebegin', renderSingleComment(c, depth));
      }

      if (rest.length > 0) {
        btn.dataset.ids = JSON.stringify(rest);
        btn.textContent = `+${rest.length} more`;
      } else {
        btn.remove();
      }
    }

    async function fetchHNItem(id) {
      if (commentCache.has(id)) return commentCache.get(id);
      const res = await fetch(`${HN_API}/item/${id}.json`);
      const item = await res.json();
      commentCache.set(id, item);
      return item;
    }

    function renderSingleComment(c, depth) {
      const time = c.time ? timeAgo(c.time * 1000) : '';
      const d = Math.min(depth, 4);
      let html = `<div class="hn-comment depth-${d}">
        <div class="hn-comment-meta">
          <a href="https://news.ycombinator.com/user?id=${c.by}" target="_blank">${c.by || 'anon'}</a> Â· ${time}
        </div>
        <div class="hn-comment-text">${c.text || ''}</div>`;

      if (c.kids && c.kids.length > 0) {
        html += `<button class="hn-load-more" data-ids='${JSON.stringify(c.kids)}' data-depth="${depth + 1}" onclick="loadReplies(this)">${c.kids.length} replies</button>`;
      }

      html += '</div>';
      return html;
    }

    function timeAgo(ts) {
      const secs = Math.floor((Date.now() - ts) / 1000);
      if (secs < 60) return 'just now';
      if (secs < 3600) return Math.floor(secs / 60) + 'm ago';
      if (secs < 86400) return Math.floor(secs / 3600) + 'h ago';
      return Math.floor(secs / 86400) + 'd ago';
    }

    loadIndex();
  </script>
</body>
</html>
