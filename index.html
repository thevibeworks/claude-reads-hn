<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Reads HN</title>
  <meta name="description" content="AI-curated Hacker News digests with spicy takes. 4x daily.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“°</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* Font modes - Courier default */
    :root {
      --font-body: Courier, 'Courier New', monospace;
      --font-mono: Courier, 'Courier New', monospace;
    }
    [data-font="sans"] {
      --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Theme: Dark (default) */
    [data-theme="dark"] {
      --bg: #0a0a0a;
      --bg-card: #111111;
      --bg-elevated: #1a1a1a;
      --bg-header: rgba(10, 10, 10, 0.9);
      --fg: #e4e4e7;
      --fg-muted: #a1a1aa;
      --fg-dim: #71717a;
      --accent: #f97316;
      --link: #60a5fa;
      --border: #27272a;
      --tldr: #a78bfa;
      --take: #f472b6;
      --comment: #34d399;
    }

    /* Theme: Light */
    [data-theme="light"] {
      --bg: #ffffff;
      --bg-card: #f9fafb;
      --bg-elevated: #f3f4f6;
      --bg-header: rgba(255, 255, 255, 0.9);
      --fg: #18181b;
      --fg-muted: #52525b;
      --fg-dim: #a1a1aa;
      --accent: #ea580c;
      --link: #2563eb;
      --border: #e5e7eb;
      --tldr: #7c3aed;
      --take: #db2777;
      --comment: #059669;
    }

    /* Theme: Sepia */
    [data-theme="sepia"] {
      --bg: #f5f0e6;
      --bg-card: #ebe5d9;
      --bg-elevated: #e0d9cc;
      --bg-header: rgba(245, 240, 230, 0.9);
      --fg: #3d3327;
      --fg-muted: #6b5d4d;
      --fg-dim: #9a8b78;
      --accent: #b45309;
      --link: #92400e;
      --border: #d4cabb;
      --tldr: #7e22ce;
      --take: #be185d;
      --comment: #047857;
    }

    /* Theme: Hacker */
    [data-theme="hacker"] {
      --bg: #0d0d0d;
      --bg-card: #0f1a0f;
      --bg-elevated: #132513;
      --bg-header: rgba(13, 13, 13, 0.95);
      --fg: #33ff33;
      --fg-muted: #22aa22;
      --fg-dim: #116611;
      --accent: #00ff00;
      --link: #33ff99;
      --border: #1a3a1a;
      --tldr: #ffff00;
      --take: #ff6600;
      --comment: #00ffff;
    }

    /* Theme: HN Orange */
    [data-theme="hn"] {
      --bg: #f6f6ef;
      --bg-card: #ffffff;
      --bg-elevated: #f0f0e8;
      --bg-header: rgba(255, 102, 0, 0.95);
      --fg: #000000;
      --fg-muted: #666666;
      --fg-dim: #999999;
      --accent: #ff6600;
      --link: #000000;
      --border: #e0e0d8;
      --tldr: #7c3aed;
      --take: #db2777;
      --comment: #059669;
    }
    [data-theme="hn"] .header { background: var(--bg-header); }
    [data-theme="hn"] .logo, [data-theme="hn"] .nav a { color: #000; }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--fg);
      line-height: 1.7;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
      transition: background 0.2s ease, color 0.2s ease;
    }
    [data-font="mono"] body {
      line-height: 1.6;
      letter-spacing: 0;
    }

    .container {
      max-width: 680px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Layout with sidebar */
    .layout {
      display: block;
      max-width: 680px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    .main-content {
      width: 100%;
      min-width: 0;
    }
    .sidebar {
      display: none;
    }
    @media (min-width: 1000px) {
      .layout {
        display: flex;
        max-width: 1100px;
      }
      .main-content {
        flex: 1;
        max-width: 680px;
      }
      .sidebar {
        display: block;
        width: 240px;
        flex-shrink: 0;
        margin-left: 2rem;
        position: sticky;
        top: 80px;
        height: fit-content;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
      }
    }
    .sidebar-section {
      margin-bottom: 1.5rem;
    }
    .sidebar-title {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--fg-dim);
      margin-bottom: 0.75rem;
    }
    .sidebar-item {
      display: block;
      padding: 0.4rem 0.6rem;
      margin-bottom: 0.25rem;
      font-size: 0.75rem;
      color: var(--fg-muted);
      text-decoration: none;
      border-radius: 4px;
      border-left: 2px solid transparent;
      transition: all 0.15s ease;
      line-height: 1.4;
    }
    .sidebar-item:hover {
      color: var(--fg);
      background: var(--bg-elevated);
      text-decoration: none;
    }
    .sidebar-item.active {
      color: var(--accent);
      border-left-color: var(--accent);
      background: var(--bg-elevated);
    }
    .sidebar-num {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      opacity: 0.5;
      margin-right: 0.4rem;
    }

    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      background: var(--bg-header);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
      z-index: 100;
    }
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--fg);
      letter-spacing: -0.02em;
    }
    .nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
    @media (min-width: 600px) {
      .nav { gap: 0.75rem; }
    }
    /* Nav icons */
    .nav-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--fg-muted);
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
    }
    .nav-icon:hover {
      border-color: var(--accent);
      color: var(--accent);
      text-decoration: none;
    }
    .nav-icon.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    .nav-icon svg { display: block; }

    /* Theme picker */
    .theme-picker {
      position: relative;
    }
    .theme-menu {
      display: none;
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0;
      min-width: 120px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
    }
    .theme-menu.show { display: block; }
    .theme-option {
      display: block;
      width: 100%;
      padding: 0.5rem 1rem;
      text-align: left;
      background: none;
      border: none;
      color: var(--fg-muted);
      font-size: 0.8rem;
      cursor: pointer;
      font-family: inherit;
    }
    .theme-option:hover {
      background: var(--bg-elevated);
      color: var(--fg);
    }
    .theme-option.active {
      color: var(--accent);
    }

    /* Feed */
    .feed {
      padding: 2rem 0 4rem;
    }

    /* Digest block */
    .digest {
      margin-bottom: 3rem;
      padding-bottom: 3rem;
      border-bottom: 1px solid var(--border);
    }
    .digest:last-child {
      border-bottom: none;
    }

    .digest-header {
      margin-bottom: 1.5rem;
    }
    .digest-date {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      color: var(--fg-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    .digest-vibe {
      font-style: italic;
      color: var(--fg-muted);
      font-size: 0.95rem;
      padding-left: 1rem;
      border-left: 2px solid var(--accent);
    }

    /* Story */
    .story {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      transition: border-color 0.15s ease;
    }
    .story:hover {
      border-color: var(--fg-dim);
    }

    .story-title {
      font-size: 1.05rem;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 0.25rem;
    }
    .story-title a {
      color: var(--fg);
    }
    .story-title a:hover {
      color: var(--accent);
    }

    .story-meta {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--fg-dim);
      margin-bottom: 1rem;
    }
    .story-meta a {
      color: var(--fg-dim);
    }
    .story-meta a:hover {
      color: var(--link);
    }
    .story-stats {
      cursor: help;
      border-bottom: 1px dotted var(--fg-dim);
    }

    /* Anchor offset for sticky header */
    .story[id] {
      scroll-margin-top: 80px;
    }

    .story-section {
      margin-top: 1rem;
      padding-top: 0.75rem;
    }

    .story-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.4rem;
    }

    .story-tldr .story-label { color: var(--tldr); }
    .story-take .story-label { color: var(--take); }
    .story-comment .story-label { color: var(--comment); }

    .story-text {
      font-size: 0.9rem;
      line-height: 1.65;
      color: var(--fg-muted);
    }

    .story-quote {
      font-style: italic;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border-radius: 6px;
      border-left: 3px solid var(--comment);
      font-size: 0.9rem;
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }
    .story-quote:last-child { margin-bottom: 0; }
    .story-quote:nth-child(2) { border-left-color: var(--take); }
    .story-quote:nth-child(3) { border-left-color: var(--tldr); }
    .story-quote-author {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--fg-dim);
      font-style: normal;
      margin-top: 0.5rem;
    }

    /* Expand discussion */
    .expand-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 1rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--fg-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .expand-btn:hover {
      border-color: var(--accent);
      color: var(--fg);
    }
    .expand-btn.loading {
      opacity: 0.6;
      cursor: wait;
    }

    .hn-comments {
      margin-top: 1rem;
      border-top: 1px solid var(--border);
      padding-top: 1rem;
    }
    .hn-comment {
      margin-bottom: 0.75rem;
      padding-left: 0.75rem;
      border-left: 2px solid var(--border);
    }
    .hn-comment.depth-0 { border-left-color: var(--accent); }
    .hn-comment.depth-1 { margin-left: 1rem; border-left-color: var(--fg-dim); }
    .hn-comment.depth-2 { margin-left: 2rem; border-left-color: var(--fg-dim); opacity: 0.9; }
    .hn-comment.depth-3 { margin-left: 3rem; border-left-color: var(--fg-dim); opacity: 0.8; }
    .hn-comment.depth-4 { margin-left: 4rem; border-left-color: var(--fg-dim); opacity: 0.7; }
    .hn-comment-meta {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--fg-dim);
      margin-bottom: 0.3rem;
    }
    .hn-comment-meta a { color: var(--fg-dim); }
    .hn-comment-meta a:hover { color: var(--accent); }
    .hn-comment-text {
      font-size: 0.85rem;
      line-height: 1.6;
      color: var(--fg-muted);
    }
    .hn-comment-text a { color: var(--link); }
    .hn-comment-text code {
      background: var(--bg-elevated);
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 0.8em;
    }
    .hn-comment-text pre {
      background: var(--bg-elevated);
      padding: 0.75rem;
      border-radius: 4px;
      overflow-x: auto;
      margin: 0.5rem 0;
    }
    .hn-comment-text p { margin: 0.4rem 0; }
    .hn-load-more {
      font-size: 0.7rem;
      color: var(--fg-dim);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.3rem 0;
      margin-left: 1rem;
    }
    .hn-load-more:hover { color: var(--accent); }
    .hn-dead { opacity: 0.4; font-style: italic; }

    /* Tags */
    .story-tags {
      margin-top: 1rem;
      padding-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .tag {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--accent);
      background: transparent;
      padding: 0.2rem 0;
      text-decoration: none;
    }
    .tag:hover {
      text-decoration: underline;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 4rem 1rem;
      color: var(--fg-muted);
    }

    .load-more {
      display: block;
      width: 100%;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--fg-muted);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    .load-more:hover {
      background: var(--bg-elevated);
      color: var(--fg);
      border-color: var(--accent);
    }

    /* Footer */
    .footer {
      padding: 2rem 0;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 0.75rem;
      color: var(--fg-dim);
    }
    .footer a { color: var(--fg-dim); }
    .footer a:hover { color: var(--accent); }

    /* Mobile */
    @media (max-width: 600px) {
      html { font-size: 15px; }
      .story { padding: 1.25rem; }
      .header-inner { flex-wrap: wrap; gap: 0.75rem; }
      .nav { gap: 0.75rem; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <div class="logo">Claude Reads HN</div>
      <nav class="nav">
        <a href="https://t.me/claudehn" class="nav-icon" title="Telegram"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a>
        <a href="https://github.com/thevibeworks/claude-reads-hn" class="nav-icon" title="GitHub"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a>
        <button class="nav-icon" id="fontToggle" onclick="toggleFont()" title="Toggle font"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="4" y="17" font-size="14" font-family="serif" fill="currentColor" stroke="none">Aa</text></svg></button>
        <div class="theme-picker">
          <button class="nav-icon theme-btn" onclick="toggleThemeMenu()" title="Theme"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
          <div class="theme-menu" id="themeMenu">
            <button class="theme-option" onclick="setTheme('dark')">Dark</button>
            <button class="theme-option" onclick="setTheme('light')">Light</button>
            <button class="theme-option" onclick="setTheme('sepia')">Sepia</button>
            <button class="theme-option" onclick="setTheme('hacker')">Hacker</button>
            <button class="theme-option" onclick="setTheme('hn')">HN Orange</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <div class="layout">
    <main class="main-content feed" id="feed">
      <div class="loading">Loading feed...</div>
    </main>
    <aside class="sidebar" id="sidebar"></aside>
  </div>

  <footer class="footer">
    <div class="container">
      Claude (AI)-curated HN digests Â· 4x daily Â·
      <a href="https://t.me/claudehn">t.me/claudehn</a>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Theme management
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeMenu(theme);
      toggleThemeMenu();
    }

    function toggleThemeMenu() {
      document.getElementById('themeMenu').classList.toggle('show');
    }

    function updateThemeMenu(theme) {
      document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().replace(' ', '') === theme ||
          (btn.textContent === 'HN Orange' && theme === 'hn'));
      });
    }

    // Font toggle (default is Courier, toggle to sans)
    function toggleFont() {
      const isSans = document.documentElement.getAttribute('data-font') === 'sans';
      const newFont = isSans ? 'mono' : 'sans';
      document.documentElement.setAttribute('data-font', newFont);
      localStorage.setItem('font', newFont);
      document.getElementById('fontToggle').classList.toggle('active', newFont === 'sans');
    }

    // Close menu on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.theme-picker')) {
        document.getElementById('themeMenu').classList.remove('show');
      }
    });

    // Load saved preferences (Courier is default)
    const savedTheme = localStorage.getItem('theme') || 'dark';
    const savedFont = localStorage.getItem('font') || 'mono';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.documentElement.setAttribute('data-font', savedFont);
    updateThemeMenu(savedTheme);
    if (savedFont === 'sans') document.getElementById('fontToggle').classList.add('active');

    // Feed loading
    const REPO_RAW = 'https://raw.githubusercontent.com/thevibeworks/claude-reads-hn/main';
    let digestsIndex = [];
    let loadedCount = 0;
    const BATCH_SIZE = 5;
    let allStories = []; // for sidebar

    async function loadIndex() {
      try {
        const res = await fetch(`${REPO_RAW}/llms.txt?t=${Date.now()}`);
        const text = await res.text();

        digestsIndex = text.split('\n')
          .filter(l => l.startsWith('- ['))
          .map(line => {
            const match = line.match(/- \[([^\]]+)\]\(([^)]+)\): ([^|]+)\| (.+)/);
            if (!match) return null;
            return { date: match[1], path: match[2], topics: match[3].trim(), ids: match[4].trim() };
          })
          .filter(Boolean);

        document.getElementById('feed').innerHTML = '';
        await loadMore();
      } catch (e) {
        document.getElementById('feed').innerHTML = `<p class="loading">Error: ${e.message}</p>`;
      }
    }

    async function loadMore() {
      const batch = digestsIndex.slice(loadedCount, loadedCount + BATCH_SIZE);
      if (batch.length === 0) return;

      for (const d of batch) {
        try {
          const res = await fetch(`${REPO_RAW}/${d.path}`);
          const md = await res.text();
          const { html, stories } = parseDigest(md, d.date);
          document.getElementById('feed').insertAdjacentHTML('beforeend', html);
          allStories.push(...stories);
        } catch (e) {
          console.error(`Failed to load ${d.path}:`, e);
        }
      }

      loadedCount += batch.length;
      updateSidebar();

      if (loadedCount < digestsIndex.length) {
        document.getElementById('feed').insertAdjacentHTML('beforeend', `
          <button class="load-more" onclick="this.remove(); loadMore();">
            Load more (${digestsIndex.length - loadedCount} remaining)
          </button>
        `);
      }
    }

    function updateSidebar() {
      const sidebar = document.getElementById('sidebar');
      let html = '<div class="sidebar-section"><div class="sidebar-title">Highlights</div>';
      allStories.forEach((s, i) => {
        const label = s.highlight || (s.title.length > 30 ? s.title.slice(0, 30) + '...' : s.title);
        html += `<a href="#${s.id}" class="sidebar-item" data-id="${s.id}"><span class="sidebar-num">${i + 1}</span>${escapeHtml(label)}</a>`;
      });
      html += '</div>';
      sidebar.innerHTML = html;
    }

    // Scroll tracking for sidebar
    let ticking = false;
    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActiveStory();
          ticking = false;
        });
        ticking = true;
      }
    }

    function updateActiveStory() {
      const stories = document.querySelectorAll('.story[id]');
      let currentId = null;
      const offset = 150;

      for (const story of stories) {
        const rect = story.getBoundingClientRect();
        if (rect.top <= offset) {
          currentId = story.id;
        }
      }

      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.toggle('active', item.dataset.id === currentId);
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });

    function parseDigest(md, date) {
      const lines = md.split('\n');
      let vibe = '';
      let highlights = [];
      let stories = [];
      let currentStory = null;
      let storyIdx = 0;
      const digestId = date.replace(/[:\s-]/g, '');

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        if (line.startsWith('> ') && !vibe && i < 10) {
          vibe = line.slice(2);
          continue;
        }

        if (line.startsWith('- ') && line.includes(':') && i < 20) {
          const hl = line.slice(2).split(':')[0];
          if (hl && hl.length < 50) highlights.push(hl);
          continue;
        }

        if (line.startsWith('### [')) {
          if (currentStory) stories.push(currentStory);
          const titleMatch = line.match(/### \[([^\]]+)\]\(([^)]+)\)(.*)/);
          if (titleMatch) {
            storyIdx++;
            currentStory = {
              id: `${digestId}-${storyIdx}`,
              title: titleMatch[1],
              url: titleMatch[2],
              meta: titleMatch[3].replace(/[â€¢Â·]/g, '').trim(),
              hnUrl: '',
              hnId: '',
              tldr: '',
              take: '',
              comments: [],
              tags: []
            };
          }
          continue;
        }

        if (!currentStory) continue;

        if (line.includes('news.ycombinator.com/item')) {
          const hnMatch = line.match(/\((https:\/\/news\.ycombinator\.com\/item\?id=(\d+))\)/);
          if (hnMatch) {
            currentStory.hnUrl = hnMatch[1];
            currentStory.hnId = hnMatch[2];
          }
          continue;
        }

        if (line.startsWith('TLDR:')) {
          currentStory.tldr = line.slice(5).trim();
          continue;
        }

        if (line.startsWith('Take:')) {
          currentStory.take = line.slice(5).trim();
          continue;
        }

        // Support both old "Comment:" and new "Comments:" format
        if (line.startsWith('Comment:') && !line.startsWith('Comments:')) {
          const commentMatch = line.match(/Comment:\s*"([^"]+)"\s*-(\w+)/);
          if (commentMatch) {
            currentStory.comments.push({ text: commentMatch[1], author: commentMatch[2] });
          }
          continue;
        }

        // New multi-comment format: - "quote" -username
        if (line.startsWith('- "') && currentStory) {
          const multiMatch = line.match(/^- "([^"]+)"\s*-(\w+)/);
          if (multiMatch) {
            currentStory.comments.push({ text: multiMatch[1], author: multiMatch[2] });
          }
          continue;
        }

        if (line.startsWith('Tags:')) {
          const tagsMatch = line.match(/#\w+/g);
          if (tagsMatch) currentStory.tags = tagsMatch;
          continue;
        }
      }

      if (currentStory) stories.push(currentStory);

      // Format date nicely (no UTC suffix)
      const formattedDate = formatDate(date);

      let html = `<article class="digest" id="d-${digestId}">
        <header class="digest-header">
          <div class="digest-date">${formattedDate}</div>
          ${vibe ? `<div class="digest-vibe">${escapeHtml(vibe)}</div>` : ''}
        </header>`;

      // Attach highlights to stories for sidebar
      highlights.slice(0, 5).forEach((h, idx) => {
        if (stories[idx]) stories[idx].highlight = h;
      });

      for (const s of stories) {
        html += `<div class="story" id="${s.id}">
          <h3 class="story-title"><a href="${escapeHtml(s.url)}" target="_blank">${escapeHtml(s.title)}</a></h3>
          <div class="story-meta">
            ${s.meta ? `<span class="story-stats" title="Stats from when story was fetched">${escapeHtml(s.meta)}</span> Â· ` : ''}
            ${s.hnUrl ? `<a href="${escapeHtml(s.hnUrl)}" target="_blank">HN#${s.hnId}</a>` : ''}
          </div>
          ${s.tldr ? `<div class="story-section story-tldr">
            <div class="story-label">TL;DR</div>
            <div class="story-text">${escapeHtml(s.tldr)}</div>
          </div>` : ''}
          ${s.take ? `<div class="story-section story-take">
            <div class="story-label">Take</div>
            <div class="story-text">${escapeHtml(s.take)}</div>
          </div>` : ''}
          ${s.comments.length > 0 ? `<div class="story-section story-comment">
            <div class="story-label">${s.comments.length > 1 ? 'HN Voices' : 'Best Comment'}</div>
            ${s.comments.map(c => `<div class="story-quote">
              "${escapeHtml(c.text)}"
              <div class="story-quote-author">â€” ${escapeHtml(c.author)}</div>
            </div>`).join('')}
          </div>` : ''}
          ${s.tags.length > 0 ? `<div class="story-tags">${s.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join(' ')}</div>` : ''}
          ${s.hnId ? `<button class="expand-btn" onclick="expandDiscussion(this, '${s.hnId}')">Read HN discussion</button>` : ''}
        </div>`;
      }

      html += '</article>';
      return { html, stories };
    }

    function formatDate(dateStr) {
      // Input: "2025-12-13 00:44" (UTC) -> local timezone display
      const parts = dateStr.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);
      if (!parts) return dateStr;
      const [_, y, m, d, h, min] = parts;
      const utcDate = new Date(Date.UTC(parseInt(y), parseInt(m)-1, parseInt(d), parseInt(h), parseInt(min)));

      // Format in user's local timezone
      const opts = { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
      return utcDate.toLocaleString(undefined, opts);
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // HN Discussion expansion - lazy load, no recursion
    const HN_API = 'https://hacker-news.firebaseio.com/v0';
    const commentCache = new Map();

    async function expandDiscussion(btn, hnId) {
      if (btn.classList.contains('loading')) return;

      const story = btn.closest('.story');
      let container = story.querySelector('.hn-comments');

      if (container) {
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
        btn.textContent = container.style.display === 'none' ? 'Read HN discussion' : 'Hide discussion';
        return;
      }

      btn.classList.add('loading');
      btn.textContent = 'Loading...';

      try {
        const item = await fetchHNItem(hnId);
        if (!item || !item.kids || item.kids.length === 0) {
          btn.textContent = 'No comments yet';
          btn.disabled = true;
          return;
        }

        container = document.createElement('div');
        container.className = 'hn-comments';

        // Only fetch top-level comments (first 10), no recursion
        const topKids = item.kids.slice(0, 10);
        const comments = await Promise.all(topKids.map(id => fetchHNItem(id)));

        for (const c of comments) {
          if (!c || c.deleted) continue;
          container.insertAdjacentHTML('beforeend', renderSingleComment(c, 0));
        }

        if (item.kids.length > 10) {
          container.insertAdjacentHTML('beforeend',
            `<button class="hn-load-more" data-ids='${JSON.stringify(item.kids.slice(10))}' onclick="loadMoreTop(this)">Load ${item.kids.length - 10} more comments</button>`);
        }

        story.appendChild(container);
        btn.textContent = 'Hide discussion';
      } catch (e) {
        console.error('Failed:', e);
        btn.textContent = 'Failed to load';
      } finally {
        btn.classList.remove('loading');
      }
    }

    async function loadMoreTop(btn) {
      const ids = JSON.parse(btn.dataset.ids);
      const batch = ids.slice(0, 10);
      const rest = ids.slice(10);

      btn.textContent = 'Loading...';
      const comments = await Promise.all(batch.map(id => fetchHNItem(id)));

      for (const c of comments) {
        if (!c || c.deleted) continue;
        btn.insertAdjacentHTML('beforebegin', renderSingleComment(c, 0));
      }

      if (rest.length > 0) {
        btn.dataset.ids = JSON.stringify(rest);
        btn.textContent = `Load ${rest.length} more comments`;
      } else {
        btn.remove();
      }
    }

    async function loadReplies(btn) {
      const ids = JSON.parse(btn.dataset.ids);
      const depth = parseInt(btn.dataset.depth);
      const batch = ids.slice(0, 5);
      const rest = ids.slice(5);

      btn.textContent = 'Loading...';
      const comments = await Promise.all(batch.map(id => fetchHNItem(id)));

      for (const c of comments) {
        if (!c || c.deleted) continue;
        btn.insertAdjacentHTML('beforebegin', renderSingleComment(c, depth));
      }

      if (rest.length > 0) {
        btn.dataset.ids = JSON.stringify(rest);
        btn.textContent = `+${rest.length} more`;
      } else {
        btn.remove();
      }
    }

    async function fetchHNItem(id) {
      if (commentCache.has(id)) return commentCache.get(id);
      const res = await fetch(`${HN_API}/item/${id}.json`);
      const item = await res.json();
      commentCache.set(id, item);
      return item;
    }

    function renderSingleComment(c, depth) {
      const time = c.time ? timeAgo(c.time * 1000) : '';
      const d = Math.min(depth, 4);
      let html = `<div class="hn-comment depth-${d}">
        <div class="hn-comment-meta">
          <a href="https://news.ycombinator.com/user?id=${c.by}" target="_blank">${c.by || 'anon'}</a> Â· ${time}
        </div>
        <div class="hn-comment-text">${c.text || ''}</div>`;

      if (c.kids && c.kids.length > 0) {
        html += `<button class="hn-load-more" data-ids='${JSON.stringify(c.kids)}' data-depth="${depth + 1}" onclick="loadReplies(this)">${c.kids.length} replies</button>`;
      }

      html += '</div>';
      return html;
    }

    function timeAgo(ts) {
      const secs = Math.floor((Date.now() - ts) / 1000);
      if (secs < 60) return 'just now';
      if (secs < 3600) return Math.floor(secs / 60) + 'm ago';
      if (secs < 86400) return Math.floor(secs / 3600) + 'h ago';
      return Math.floor(secs / 86400) + 'd ago';
    }

    loadIndex();
  </script>
</body>
</html>
